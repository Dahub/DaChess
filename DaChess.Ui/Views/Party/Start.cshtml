@model string

@{
    ViewBag.Title = "Start";
}

<script type="text/javascript">
    var party = {
        Id: 0,
        Name: '',
        Board: '',
        WhiteToken: '',
        BlackToken: '',
        WhiteTurn: true,
        IsReady: false,
        WhiteAskToPlay: false,
        BlackAskToPlay: false,
    }

    $(document).ready(function () {
        var partyName = { name: '@Model' };
        $.ajax({
            url: '@(String.Concat(ConfigurationWrapper.Instance.WebApiUrl, "/api/party"))',
            data: partyName,
            cache: false,
            type: 'GET',
            dataType: "json",
            contentType: 'application/json; charset=utf-8'
        }).done(function (data) {
            mapParty(data);
            if (false == isEmpty(party.WhiteToken)) {
                $('#whiteBtn').prop('disabled', true);
                $('#whiteBtn').removeClass('btn-success');
            }
            else {
                $('#whiteBtn').prop('disabled', false);
                $('#whiteBtn').addClass('btn-success');
            }

            if (false == isEmpty(party.BlackToken)) {
                $('#blackBtn').prop('disabled', true);
                $('#blackBtn').removeClass('btn-success');
            }
            else {
                $('#blackBtn').prop('disabled', false);
                $('#blackBtn').addClass('btn-success');
            }
        });

        $("#whiteBtn").click(function () {
            party.WhiteAskToPlay = true;
            addPlayer('white');
        });

        $("#blackBtn").click(function () {
            party.BlackAskToPlay = true;
            addPlayer('black');
        });
    });
</script>

<input type="hidden" id="isWhitePlayer" value="false" />
<input type="hidden" id="isBlackPlayer" value="true" />
<input type="hidden" id="token" value="" />

<h2>DaChess</h2>
<div class="row">
    <div class="col-md-2 col-md-offset-1">
        <div class="centerBlock">
            <button type="button" id="whiteBtn" class="btn-lg" disabled>Jouer avec les blancs</button>
        </div>
    </div>
    <div class="col-md-6">
        <div class="centerBlock">
            @Html.Partial("_Board")
        </div>
    </div>
    <div class="col-md-2">
        <div class="centerBlock">
            <button type="button" id="blackBtn" class="btn-lg" disabled>Jouer avec les noirs</button>
        </div>
    </div>
</div>
<br /><hr /><br />
<div class="row">
    <div class="col-md-6 col-md-offset-3">
        <input type="text" id="message" />
        <input type="button" id="sendmessage" value="Envoyer" />
        <input type="hidden" id="displayname" value="Lurker" />
        <ul id="discussion"></ul>
    </div>
</div>

<script>
    $(function () {
        var partyHub = $.connection.partyHub;
        partyHub.client.addNewMessageToPage = function (name, message) {
            console.log(name);
            $('#discussion').append('<li><strong>' + htmlEncode(name)
                + '</strong>: ' + htmlEncode(message) + '</li>');
        };

        partyHub.client.addPlayerWhite = function () {
            $('#whiteBtn').prop('disabled', true);
            $('#whiteBtn').html('Joueur connecté');
            $('#whiteBtn').removeClass('btn-success');
        };

        partyHub.client.addPlayerBlack = function () {
            $('#blackBtn').prop('disabled', true);
            $('#blackBtn').html('Joueur connecté');
            $('#blackBtn').removeClass('btn-success');
        };

        $('#displayname').val('Anonymous');
        $('#message').focus();
        $.connection.hub.start().done(function () {
            partyHub.server.joinParty('@Model');

            $('#sendmessage').click(function () {
                partyHub.server.sendMessage('@Model', $('#displayname').val(), $('#message').val());
                $('#message').val('').focus();
            });
        });
    });
    // This optional function html-encodes messages for display in the page.
    function htmlEncode(value) {
        var encodedValue = $('<div />').text(value).html();
        return encodedValue;
    }

    function addPlayer(color) {
        $.ajax({
            url: '@(String.Concat(ConfigurationWrapper.Instance.WebApiUrl, "/api/player"))',
            data: JSON.stringify(party),
            cache: false,
            type: 'POST',
            dataType: "json",
            contentType: 'application/json; charset=utf-8'
        }).done(function (data) {
            mapParty(data);
            $('#token').val(data.WhiteToken);
            var partyHub = $.connection.partyHub;
            if (color == 'white') {
                $('#displayname').val('Blancs');
                $('#isWhitePlayer').val('true');
                $('#token').val(data.WhiteToken);
                if ($('#blackBtn').prop('disabled') == false) {
                    $('#blackBtn').prop('disabled', true);
                    $('#blackBtn').html('Attente du joueur');
                    $('#blackBtn').removeClass('btn-success');
                }
                partyHub.server.sendAddWhitePlayer('@Model');               
            } else {
                $('#displayname').val('Noirs');
                $('#isBlackPlayer').val('true');
                $('#token').val(data.BlackToken);
                if ($('#whiteBtn').prop('disabled') == false) {
                    $('#whiteBtn').prop('disabled', true);
                    $('#whiteBtn').html('Attente du joueur');
                    $('#whiteBtn').removeClass('btn-success');
                }
                partyHub.server.sendAddBlackPlayer('@Model');                
            }
        });
    }

    function mapParty(data) {
        party.Id = data.Id;
        party.Name = data.Name;
        party.Board = data.Board;
        party.WhiteToken = data.WhiteToken;
        party.BlackToken = data.BlackToken;
        party.WhiteTurn = data.WhiteTurn;
        party.IsReady = data.IsReady;
    }
    function isEmpty(str) {
        return (!str || 0 === str.length);
    }
</script>

